#!/bin/bash
set -e

IMAGE="mcr.microsoft.com/playwright:v1.57.0-noble"

docker run --rm --ipc=host --platform linux/amd64 \
  -v "${PWD%/*/*}":/tests \
  -v /tests/node_modules \
  -e NODE_ENV=test \
  ${CI:+-e CI=true} \
  "${IMAGE}" \
  /bin/bash -c "\
    cd /tests \
    && npm ci \
    && npm run build:lib \
    && cd apps/storybook && NODE_ENV=test npx storybook build \
    && cd /tests/packages/e2e && npx tsx scripts/playwright/playwright.generate-tests.ts \
    && cd /tests \
    && npx playwright install chrome \
    && npx start-server-and-test \
      'npx http-server /tests/apps/storybook/storybook-static -p 6006' \
      6006 \
      'cd packages/e2e && npx playwright test --update-snapshots --max-failures 0' \
  "
